---
title: "Labcyte-RT Data Analysis (MOIRAI BED FILES)"
output:
  html_document:
    keep_md: yes
    number_sections: yes
    toc: yes
  pdf_document:
    toc: yes
---

```{r echo=FALSE}
knitr::opts_chunk$set(cache  = TRUE)
knitr::opts_knit$set(verbose = TRUE)
ggplot2::theme_set(ggplot2::theme_bw())
```

Data load and QC in R
=====================

```{r load_R_libraries, message = F}
BS_GENOME    <- "BSgenome.Mmusculus.UCSC.mm9" 
library(BS_GENOME, character.only = T)
library(CAGEr)
library(data.table)
library(ggplot2)
library(gplots)
library('RColorBrewer')
library(magrittr)
library(plyr)
library(MultiAssayExperiment)
library(SummarizedExperiment)
library(reshape)
library(vegan)
```

MOIRAI shortcuts

```{r moirai_shortcuts}
WORKFLOW       <- "OP-WORKFLOW-CAGEscan-short-reads-v2.1~rc1"
MOIRAI_PROJ    <- "project/Labcyte" 
MOIRAI_USER    <- "nanoCAGE2" 
ASSEMBLY       <- "mm9"
BASEDIR        <- "/osc-fs_home/scratch/moirai"
MOIRAI_BASE    <- file.path(BASEDIR, MOIRAI_USER)
MOIRAI_RESULTS <- file.path(MOIRAI_BASE, MOIRAI_PROJ)
```

Load CAGE libraries
===================

Load summary statistics from MOIRAI and polish the names
--------------------------------------------------------

```{r MOIRAI}
libs <- smallCAGEqc::loadMoiraiStats(
  pipeline  = "OP-WORKFLOW-CAGEscan-short-reads-v2.0",
  multiplex = file.path( MOIRAI_BASE, "input/171227_M00528_0321_000000000-B4GLP.multiplex.txt"),
  summary   = file.path( MOIRAI_RESULTS,"171227_M00528_0321_000000000-B4GLP.OP-WORKFLOW-CAGEscan-short-reads-v2.1~rc1.20180104125850/text/summary.txt"))
libs$barcode_ID <- c(1:70)
libs$inputFiles <- list.files(path = "/osc-fs_home/scratch/moirai/nanoCAGE2/project/Labcyte/171227_M00528_0321_000000000-B4GLP.OP-WORKFLOW-CAGEscan-short-reads-v2.1~rc1.20180104125850/CAGEscan_fragments")
libs$inputFiles <- paste0("/osc-fs_home/scratch/moirai/nanoCAGE2/project/Labcyte/171227_M00528_0321_000000000-B4GLP.OP-WORKFLOW-CAGEscan-short-reads-v2.1~rc1.20180104125850/CAGEscan_fragments/", libs$inputFiles)
libs$inputFilesType <- c("bed")
libs$sampleLabels <- as.character(libs$samplename)
#libs
```


```{r PLATE}
plate <- read.table("plate.txt", sep = "\t", header = TRUE)
plate_10ng <- subset(plate, plate$RNA == 10)
plate_10ng_no_RNA <- plate[224:230,]
plate_10ng_all <- rbind(plate_10ng, plate_10ng_no_RNA)
#plate_10ng_all
```

```{r LIBS}
libs <- cbind(libs, plate_10ng_all)
libs[,24] <- NULL
#rownames(libs) <- NULL
libs$PRIMERS_RATIO <- sub("no_RT_PRIMERS", "NA", libs$PRIMERS_RATIO)
libs$PRIMERS_RATIO <- as.numeric(libs$PRIMERS_RATIO)
libs$RNA <- as.numeric(libs$RNA)
libs <- libs[order(-libs$PRIMERS_RATIO),]
libs <- libs[order(-libs$RNA),]
libs$PRIMERS_RATIO[is.na(libs$PRIMERS_RATIO)] <- "no_RT_PRIMERS"
libs
```

Create a CAGEexp object and load expression data
------------------------------------------------

```{r new_CAGEexp, message = F, echo = FALSE}
myCAGEexp <- CAGEexp(colData = DataFrame(libs)
                     , metadata = list( genomeName = BS_GENOME
                                        , inputFilesType = "bed"))

getCTSS(myCAGEexp)
normalizeTagCount(myCAGEexp, method = "simpleTpm")
```

Number of sequencing reads extracted per sample
-----------------------------------------------

```{r sample stats}
data.frame(colData(myCAGEexp)[,"extracted",drop=F])
```

CTSS ANALYSIS
=============

Number of nanoCAGE tags mapping at CTSS positions in each group of samples
--------------------------------------------------------------------------
  
```{r CTSS_counts_distribution, dev=c('png'), fig.show='hide', results='hide', message = FALSE, warning=FALSE}
## Figures not displayed on the html/pdf output
plotReverseCumulatives(myCAGEexp[,1:7], onePlot = TRUE)
plotReverseCumulatives(myCAGEexp[,8:14], onePlot = TRUE)
plotReverseCumulatives(myCAGEexp[,15:21], onePlot = TRUE)
plotReverseCumulatives(myCAGEexp[,22:28], onePlot = TRUE)
plotReverseCumulatives(myCAGEexp[,29:35], onePlot = TRUE)
plotReverseCumulatives(myCAGEexp[,36:42], onePlot = TRUE)
#plotReverseCumulatives(myCAGEexp$RNA == "10", onePlot = TRUE)
#plotReverseCumulatives(myCAGEexp[,50:56], onePlot = TRUE)
#plotReverseCumulatives(myCAGEexp[,57:63], onePlot = TRUE)
#plotReverseCumulatives(myCAGEexp[,64:70], onePlot = TRUE)
```

Number of nanoCAGE tags mapping at CTSS positions in each sample
----------------------------------------------------------------
  
```{r ctss-analysis}
(myCAGEexp$l1 <- colSums(CTSStagCountDf(myCAGEexp) > 0))
```

Create CTSS clusters
--------------------

```{r create_CTSS_clusters, message = FALSE, warning=FALSE}
#clusterCTSS(myCAGEexp, thresholdIsTpm = FALSE, useMulticore = TRUE, nrPassThreshold = 2, removeSingletons = TRUE)
#cumulativeCTSSdistribution(myCAGEexp, clusters = "tagClusters")
##, use multicore = TRUE)
#quantilePositions(myCAGEexp, clusters = "tagClusters", qLow = 0.1, qUp = 0.9, useMulticore = TRUE)
```

Annotation with GENCODE
-----------------------
  
Collect Gencode annotations and gene symbols via AnnotationHub.

```{r expression-per-gene, message = F}
ah <- AnnotationHub::AnnotationHub()
ah["AH49547"]
```

Annotate the genomic ranges of the `tagCountMatrix` SummarizedExperiment.

```{r annotate-CAGEexp, message = FALSE, warning = FALSE}
annotateCTSS(myCAGEexp, ah[["AH49547"]])
#annotateConsensusClusters(myCAGEexp, ah[["AH49547"]])
#consensusClustersSE(myCAGEexp)
#consensusClustersGR(myCAGEexp)
```

Make a gene expression table (not really required now).

```{r CTSStoGenes-CAGEexp}
CTSStoGenes(myCAGEexp)
#CTSScoordinatesGR(myCAGEexp)
```

Save myCAGEexp file.

```{r save myCAGEexp object}
saveRDS(myCAGEexp, "myCAGEexp.Rds")
```

QC PLOTS
========

Boxplots
--------

### Extracted reads

```{r extracted_barcode, dev=c('png')}
par(mar=c(5,5,2,2), cex.main = 1, font.main = 2)
boxplot(extracted ~ barcode_ID, xlab = "Barcode ID", ylab = "Extracted reads", data = colData(myCAGEexp), cex.axis = 0.6, las = 3, main = "Number of extracted reads per sample")
```

```{r extracted_RT, dev=c('png')}
par(mar=c(5,5,2,2), cex.main = 1, font.main = 2)
boxplot(extracted ~ RT_PRIMERS, ylab = "Extracted reads", xlab = "RT_PRIMERS concentration (uM)", data = colData(myCAGEexp), cex.axis = 0.7, las = 3, main = "Number of extracted reads for different RT_PRIMERS concentrations")
```

```{r extracted_TSO, dev=c('png')}
par(mar=c(5,5,2,2), cex.main = 1, font.main = 2)
boxplot(extracted ~ TSO, ylab = "Extracted reads", xlab = "TSO concentration (uM)", data = colData(myCAGEexp), cex.axis = 0.7, las = 3, main = "Number of extracted reads for different TSO concentrations")
```

```{r extracted_ratio, dev=c('png')}
par(mar=c(7,5,2,2), cex.main = 1, font.main = 2)
boxplot(extracted ~ PRIMERS_RATIO, ylab = "Extracted reads", xlab = "Primers ratio", data = colData(myCAGEexp), cex.axis = 0.7, las = 3, main = "Number of extracted reads for different primers ratio")
```

### Artefacts

```{r artefacts_barcode, dev=c('png')}
par(mar=c(5,5,2,2), cex.main = 1, font.main = 2)
boxplot(tagdust / extracted ~ barcode_ID, xlab = "Barcode ID", ylab = "Artefacts/extracted reads", data = colData(myCAGEexp), cex.axis = 0.6, las = 3, main = "Ratio artefacts/extracted per sample")
```

```{r artefacts_RT, dev=c('png')}
par(mar=c(5,5,2,2), cex.main = 1, font.main = 2)
boxplot(tagdust / extracted ~ RT_PRIMERS, ylab = "Artefacts/extracted reads", xlab = "RT_PRIMERS concentration (uM)", data = colData(myCAGEexp), cex.axis = 0.7, las = 3, main = "Ratio artefacts/extracted for different RT_PRIMERS concentrations")
```

```{r artefacts_TSO, dev=c('png')}
par(mar=c(5,5,2,2), cex.main = 1, font.main = 2)
boxplot(tagdust / extracted ~ TSO, ylab = "Artefacts/extracted reads", xlab = "TSO concentration (uM)", data = colData(myCAGEexp), cex.axis = 0.7, las = 3, main = "Ratio artefacts/extracted for different TSO concentrations")
```

```{r artefacts_ratio, dev=c('png')}
par(mar=c(7,5,2,2), cex.main = 1, font.main = 2)
boxplot(tagdust / extracted ~ PRIMERS_RATIO, ylab = "Artefacts/extracted reads", xlab = "Primers ratio", data = colData(myCAGEexp), cex.axis = 0.7, las = 3, main = "Ratio artefacts/extracted for different primers ratio")
```

### Counts

```{r counts_barcode, dev=c('png')}
par(mar=c(5,5,2,2), cex.main = 1, font.main = 2)
boxplot(counts ~ barcode_ID, xlab = "Barcode ID", ylab = "Counts", data = colData(myCAGEexp), cex.axis = 0.6, las = 3, main = "Number of read counts per sample")
```

```{r counts_RT, dev=c('png')}
par(mar=c(5,5,2,2), cex.main = 1, font.main = 2)
boxplot(counts ~ RT_PRIMERS, ylab = "Counts", xlab = "RT_PRIMERS concentration (uM)", data = colData(myCAGEexp), cex.axis = 0.7, las = 3, main = "Number of read counts for different RT_PRIMERS concentrations")
```

```{r counts_TSO, dev=c('png')}
par(mar=c(5,5,2,2), cex.main = 1, font.main = 2)
boxplot(counts ~ TSO, ylab = "Counts", xlab = "TSO concentration (uM)", data = colData(myCAGEexp), cex.axis = 0.7, las = 3, main = "Number of read counts for different TSO concentrations")
```

```{r counts_ratio, dev=c('png')}
par(mar=c(7,5,2,2), cex.main = 1, font.main = 2)
boxplot(counts ~ PRIMERS_RATIO, ylab = "Counts", xlab = "Primers ratio", data = colData(myCAGEexp), cex.axis = 0.7, las = 3, main = "Number of read counts for different primers ratio")
```

### Genes

```{r genes_barcode, dev=c('png')}
par(mar=c(5,5,2,2), cex.main = 1, font.main = 2)
boxplot(genes ~ barcode_ID, xlab = "Barcode ID", ylab = "Genes", data = colData(myCAGEexp), cex.axis = 0.6, las = 3, main = "Number of genes detected per sample")
```

```{r genes_RT, dev=c('png')}
par(mar=c(5,5,2,2), cex.main = 1, font.main = 2)
boxplot(genes ~ RT_PRIMERS, ylab = "Genes", xlab = "RT_PRIMERS concentration (uM)", data = colData(myCAGEexp), cex.axis = 0.7, las = 3, main = "Number of genes detected for different RT_PRIMERS concentrations")
```

```{r genes_TSO, dev=c('png')}
par(mar=c(5,5,2,2), cex.main = 1, font.main = 2)
boxplot(genes ~ TSO, ylab = "Genes", xlab = "TSO concentration (uM)", data = colData(myCAGEexp), cex.axis = 0.7, las = 3, main = "Number of genes detected for different TSO concentrations")
```

```{r genes_ratio, dev=c('png')}
par(mar=c(7,5,2,2), cex.main = 1, font.main = 2)
boxplot(genes ~ PRIMERS_RATIO, ylab = "Genes", xlab = "Primers ratio", data = colData(myCAGEexp), cex.axis = 0.7, las = 3, main = "Number of genes detected for different primers ratio")
```

Dotplots
--------

### Extracted reads

```{r extracted_reads, dev=c('png'), fig.height=5.5, fig.width=10}
dotsize <- 25000
ggplot(colData(myCAGEexp) %>% data.frame, aes(x=PRIMERS_RATIO, y=extracted)) +
  stat_summary(fun.y=mean, fun.ymin=mean, fun.ymax=mean, geom="crossbar", color="gray") +
  geom_dotplot(aes(fill=group), binaxis='y', binwidth=1.5, dotsize=dotsize, stackdir='center') + theme_bw() +
  xlab("Primers ratio\n (TSO/RT_primers)") +
  labs(title = "Number of sequencing reads extracted") +
  coord_flip()
```

### Artefacts

```{r, ratio_artefact_extracted, dev=c('png'), fig.height=5.5, fig.width=10}
dotsize <- 5000
ggplot(colData(myCAGEexp) %>% data.frame, aes(x=PRIMERS_RATIO, y=tagdust)) +
  stat_summary(fun.y=mean, fun.ymin=mean, fun.ymax=mean, geom="crossbar", color="gray") +
  geom_dotplot(aes(fill=group), binaxis='y', binwidth=1, dotsize=dotsize, stackdir='center') + theme_bw() +
  xlab("Primers ratio\n (TSO/RT_primers)") +
  labs(title = "Artefacts reads per sample") +
  coord_flip()
```

Counts
------

### Gene counts

```{r gene-count by group, dev=c('png'), fig.height=5.5, fig.width=10}
dotsize <- 100
ggplot(colData(myCAGEexp) %>% data.frame, aes(x=PRIMERS_RATIO, y=genes)) +
  stat_summary(fun.y=mean, fun.ymin=mean, fun.ymax=mean, geom="crossbar", color="gray") +
  geom_dotplot(aes(fill=group), binaxis='y', binwidth=1, dotsize=dotsize, stackdir='center') + theme_bw() +
  xlab("Primers ratio\n (TSO/RT_primers)") +
  labs(title = "Average number of genes detected in each group") +
  coord_flip()
```

### Transcript counts

```{r transcripts-count by group, dev=c('png'), fig.height=5.5, fig.width=10}
dotsize <- 4000
ggplot(colData(myCAGEexp) %>% data.frame, aes(x=PRIMERS_RATIO, y=counts)) +
stat_summary(fun.y=mean, fun.ymin=mean, fun.ymax=mean, geom="crossbar", color="gray") +
geom_dotplot(aes(fill=group), binaxis='y', binwidth=1, dotsize=dotsize, stackdir='center') + theme_bw() +
xlab("Primers ratio\n (TSO/RT_primers)") +
labs(title = "Average number of molecules detected in each group") +
coord_flip()
```

Barplots
--------

### Quality control by sample

```{r qc-barplots, dev=c('png'), message = FALSE, warning = FALSE, fig.height=5.5, fig.width=10}
plotAnnot(myCAGEexp, "qc", "Quality control by sample", "barcode_ID", normalise = F)
```

### Annotations by sample

```{r annot-barplots, dev=c('png'), message = FALSE, warning = FALSE, fig.height=5.5, fig.width=10}
plotAnnot(myCAGEexp, "counts", "Annotations by sample", "barcode_ID", normalise = F)
```

Rarefaction
------------

```{r, message = FALSE}
rar1 <- hanabi(CTSStagCountDF(myCAGEexp), from = 0)
rarc <- hanabi(assay(consensusClustersSE(myCAGEexp)) %>% as.data.frame, from = 0)
rarg <- hanabi(assay(GeneExpSE(myCAGEexp)) %>% as.data.frame, from = 0)
save(rar1, rarg, file="rar.Rda") 
```

### Plot TSS discovery

```{r hanabi-TSS_byrep, dev=c('png')}
hanabiPlot(rar1, ylab='number of TSS detected', xlab='number of unique molecule counts', main=paste("TSS discovery"), group=myCAGEexp$group, legend.pos = "bottomright")
```

### Plot Cluster discovery

```{r hanabi-CTSS_clusters_byrep, dev=c('png')}
#hanabiPlot(rarc, ylab='number of CTSS clusters detected', xlab='number of unique molecule counts', main=paste("Cluster discovery"), #group=myCAGEexp$group, legend.pos = "bottomright")
```

### Plot Gene discovery

```{r hanabi-gene_byrep, dev=c('png')}
hanabiPlot(rarg, ylab='number of genes detected', xlab='number of unique molecule counts', main=paste("Gene discovery"), group=myCAGEexp$group, legend.pos = "bottomright")
```

Correlation of CTSS clusters expression across samples (sample distance)
========================================================================

Create the correlation matrix
-----------------------------

```{r cor_data, message = FALSE}
#c <- assay(consensusClustersSE(myCAGEexp)) %>% as.data.frame
#cor_clusters <- cor(log1p(c))
#cor_clusters[cor_clusters == 1] <- NA
```

Heatmap
-------

```{r pheatmap_cor_clusters, dev=c('png'), fig.height= 8, fig.width = 10}
#col <- colorRampPalette( rev(brewer.pal(9, "RdBu")) )(255)
#ann_col <- data.frame(row.names = rownames(colData(myCAGEexp)), protocol = myCAGEexp$protocol)
#ann_col$protocol <- sub("CONTROL", "CTL", ann_col$protocol)
#ann_row <- data.frame(row.names = rownames(colData(myCAGEexp)), step = myCAGEexp$step)
#ann_row$step <- sub("0", "CTL", ann_row$step)
#pheatmap::pheatmap(cor_clusters, show_colnames = F, annotation_row = ann_row, annotation_col = ann_col, color = col, main = "Correlation of consensus clusters expression across samples\n", display_numbers = TRUE, fontsize_number = 8)
```

Principal Component Analysis (PCA)
==================================

Define PCA axis based on correlation matrix
--------------------------------------------

```{r PCA_data}
#cor_clusters <- cor(log1p(c))
#PCA <- prcomp(cor_clusters, scale. = TRUE)
#dfdf <- stats:::summary.prcomp(PCA)$importance[2, ]
```

List of principal components identified ranked by % of explained variability: 

```{r, echo = FALSE}
#dfdf
```

PCA Plot 1: PC1 vs. PC2 annotated by `PRIMERS_RATIO`
----------------------------------------------------

```{r PCA_1, dev=c('png'), message = FALSE, warning = FALSE}
#ggbiplot::ggbiplot(PCA, choices=c(1,2), obs.scale = 1, var.scale = 1, groups = colData(myCAGEexp)$results, var.axes = FALSE, labels = #colData(myCAGEexp)$sampleLabels, ellipse = TRUE, margins = c(9,9))
```

Plate maps
==========

Create plate object

```{r}
plate <- as.data.frame(colData(myCAGEexp))
```

```{r}
plateMap <- function(x, title) {
  platetools::raw_map(plate[[x]], well=plate$Well, plate="384") +
  ggtitle(title) +
  viridis::scale_fill_viridis(breaks = unique(plate[[x]]))
}

plateMapLog <- function(x, title) {
  platetools::raw_map(plate[[x]], well=plate$Well, plate="384") +
  ggtitle(title) +
  viridis::scale_fill_viridis(breaks = unique(plate[[x]]), trans = "log")
}
```

RT primers
----------

```{r plot_RT_concentration}
(plot_RT <- plateMapLog("RT_PRIMERS", "RT primer concentration"))
```

TSO
---

```{r plot_TSO_concentration}
(plot_TSO <- plateMapLog("TSO", "TSO concentration"))
```

Ratio TSO / RT
--------------

```{r plot_TSO_RT_ratio}
(plot_TSO_RT_ratio <- platetools::raw_map(plate$TSO / plate$RT_PRIMERS, well=plate$Well, plate="384") +
  ggtitle("TSO / RT primer concentration") +
  viridis::scale_fill_viridis(breaks = unique(plate$TSO / plate$RT_PRIMERS), trans = "log"))
```

Extracted
----------

```{r plot_extracted}
(plot_extracted <- plateMapLog("extracted", "Extracted reads"))
```

Artefacts
----------

```{r plot_artefacts}
(plot_artefacts <- plateMapLog("tagdust", "Artefacts"))
```

rDNA
----

```{r plot_rDNA}
(plot_rDNA <- plateMapLog("rdna", "Reads mapping to rDNA"))
```

Genes
------

```{r plot_genes}
(plot_genes <- plateMapLog("genes", "Genes detected"))
```

Counts
------

```{r plot_molecules}
(plot_counts <- plateMapLog("counts", "Molecules detected"))
```

Promoters
---------

```{r plot_promoters}
(plot_promoters <- plateMapLog("promoter", "Promoters detected"))
```

Grand summary plots
===================

Extracted. artefacts, rDNA
--------------------------

```{r plate_reads, fig.height=8, fig.width=20}
ggpubr::ggarrange(ncol = 3, nrow = 2, plot_RT, plot_TSO, plot_TSO_RT_ratio, plot_extracted, plot_artefacts, plot_rDNA)
```

Molecules, genes and promoters
-------------------------------

```{r plate_counts, fig.height=8, fig.width=20}
ggpubr::ggarrange(ncol = 3, nrow = 2, plot_RT, plot_TSO, plot_TSO_RT_ratio, plot_counts, plot_genes, plot_promoters)
```

```{r}
sessionInfo()
```